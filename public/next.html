<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>META - the final</title>
    <style>
        /* CSS 样式部分保持不变 */
        body { margin: 0; padding: 0; background: #121212; color: #fff; font-family: Arial, sans-serif; overflow-x: hidden; overflow-y: auto; display: flex; align-items: flex-start; min-height: 100vh; flex-direction: column; background-image: url('./img/nextground.jpeg'); background-size: cover; background-repeat: no-repeat; background-attachment: fixed; background-position: center; padding-top: 50px; padding-bottom: 50px; box-sizing: border-box; }
        h1 { color: white; text-align: center; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); width: 100%; }
        .main-content-wrapper { display: flex; justify-content: center; align-items: center; width: 90%; max-width: 900px; margin: 0 auto 40px auto; gap: 40px; }
        #side-image { flex: 0 0 40%; max-width: 320px; height: auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); object-fit: cover; }
        #nodes-container { flex: 1; min-width: 0; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, auto); gap: 30px; position: relative; max-width: 400px; margin: 0 auto; }
        .node { display: flex; justify-content: center; align-items: center; position: relative; }
        .node-circle { width: 120px; height: 120px; background-color: rgba(50, 50, 50, 0.85); border: 2px solid #666; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-align: center; color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5); transition: transform 0.3s ease, box-shadow 0.3s ease; user-select: none; position: relative; z-index: 1; }
        .node-circle:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6); border-color: #888; }
        .node-details { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 90%; max-width: 500px; max-height: 75vh; overflow-y: auto; background-color: rgba(25, 25, 25, 0.97); padding: 25px; box-sizing: border-box; border-radius: 10px; border: 1px solid #555; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7); opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.35s ease, transform 0.35s ease, visibility 0s linear 0.35s; z-index: 100; }
        .node-details.visible { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); pointer-events: auto; transition: opacity 0.35s ease, transform 0.35s ease, visibility 0s linear 0s; }
        .node-details h3 { margin-top: 0; color: #4caf50; text-align: center; margin-bottom: 15px; }
        .node-details p { line-height: 1.6; margin-bottom: 10px; }
        .close-details-btn { position: absolute; top: 10px; right: 15px; background: transparent; border: none; color: #aaa; font-size: 1.8em; font-weight: bold; cursor: pointer; padding: 0; line-height: 1; transition: color 0.2s ease; }
        .close-details-btn:hover { color: #fff; }
        .form-container { background-color: rgba(30, 30, 30, 0.85); padding: 30px 40px; border-radius: 10px; border: 1px solid #555; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); width: 90%; max-width: 450px; box-sizing: border-box; margin: 20px auto 0 auto; }
        .form-container input[type=text] { width: 100%; padding: 10px; margin-bottom: 15px; box-sizing: border-box; background: #333; color: #fff; border: 1px solid #666; display: block; border-radius: 4px; font-size: 1em; }
        .form-container button { width: 100%; padding: 12px; background: #4caf50; color: #fff; border: none; cursor: pointer; display: block; border-radius: 4px; font-size: 1.1em; transition: background 0.3s ease; margin-top: 10px; }
        .form-container button:not(:disabled):hover { background: #45a049; }
        .form-container button:disabled { background: #666; cursor: not-allowed; }
        .error { color: red; text-align: center; margin-top: 15px; font-size: .9em; min-height: 1.2em; font-weight: bold; }
        .form-container.cooldown-active input[type=text], .form-container.cooldown-active button { background-color: #555 !important; border-color: #777 !important; color: #aaa !important; cursor: not-allowed !important; opacity: 0.7 !important; }
        .form-container.cooldown-active button:hover { background-color: #555 !important; }

        @media (max-width: 768px) {
            body { padding-top: 30px; padding-bottom: 30px; }
            .main-content-wrapper { flex-direction: column; align-items: center; width: 95%; gap: 30px; }
            #side-image { flex-basis: auto; width: 60%; max-width: 200px; }
            #nodes-container { grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 300px; }
            .node-circle { width: 100px; height: 100px; font-size: 0.9em; }
            .form-container { width: 95%; margin-top: 30px; }
            .node-details { width: 90%; max-width: 90%; max-height: 80vh; }
        }
        @media (max-width: 480px) {
            #nodes-container { grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 250px; }
            .node-circle { width: 90px; height: 90px; font-size: 0.8em;}
        }
    </style>
</head>
<body>
    <h1>最终认证</h1>

    <div class="main-content-wrapper">
        <img id="side-image" src="./img/meta.png" alt="meta示意图">
        <div id="nodes-container">
            <!-- 节点 HTML 保持不变 -->
            <div class="node" data-node-id="1"><div class="node-circle">节点一<br>起源</div><div class="node-details"><button class="close-details-btn">×</button><h3>节点一</h3><p>...</p></div></div>
            <div class="node" data-node-id="2"><div class="node-circle">节点二<br>探索</div><div class="node-details"><button class="close-details-btn">×</button><h3>节点二</h3><p>...</p></div></div>
            <div class="node" data-node-id="3"><div class="node-circle">节点三<br>裂隙</div><div class="node-details"><button class="close-details-btn">×</button><h3>节点三</h3><p>...</p></div></div>
            <div class="node" data-node-id="4"><div class="node-circle">节点四<br>真相</div><div class="node-details"><button class="close-details-btn">×</button><h3>节点四</h3><p>...</p></div></div>
        </div>
    </div>

    <div class="form-container" id="passwordFormContainer">
        <input type="text" id="passwordInput1" placeholder="请输入密钥 (next-pass-1)">
        <button id="submitButton">验证</button>
        <div class="error" id="errorMsg"></div>
    </div>

    <!-- !!! 添加 Audio 元素 !!! -->
    <audio id="background-music" src="./mp3/next.mp3" loop preload="auto"></audio>
    <!-- loop 属性使音乐循环播放, preload="auto" 建议浏览器尽快加载 -->

    <script>
        // --- DOM 元素获取 ---
        const formContainer = document.getElementById('passwordFormContainer');
        const passwordInput1 = document.getElementById('passwordInput1');
        const submitButton = document.getElementById('submitButton');
        const errorMsg = document.getElementById('errorMsg');
        const nodeCircles = document.querySelectorAll('.node-circle');
        const nodeDetailsPanels = document.querySelectorAll('.node-details');
        const nodesContainer = document.getElementById('nodes-container');
        // !!! 获取 Audio 元素 !!!
        const backgroundMusic = document.getElementById('background-music');

        // --- 状态变量 ---
        let activeCooldownTimer = null;
        let activeCooldownTimeout = null;
        // !!! 添加音乐播放状态标志 !!!
        let musicPlayed = false;

        // --- 冷却状态管理 (保持不变) ---
        function clearCooldownState(forceClearMessage = false) { /* ... */ }
        function startFrontendCooldownTimers(remaining) { /* ... */ }
        // (省略了 clearCooldownState 和 startFrontendCooldownTimers 的完整代码)
        function clearCooldownState(forceClearMessage = false) { if (activeCooldownTimer) { clearInterval(activeCooldownTimer); activeCooldownTimer = null; } if (activeCooldownTimeout) { clearTimeout(activeCooldownTimeout); activeCooldownTimeout = null; } formContainer.classList.remove('cooldown-active'); passwordInput1.disabled = false; submitButton.disabled = false; submitButton.textContent = '验证'; if (forceClearMessage) { errorMsg.textContent = ''; } }
        function startFrontendCooldownTimers(remaining) { passwordInput1.disabled = true; submitButton.disabled = true; formContainer.classList.add('cooldown-active'); submitButton.textContent = '请等待...'; let countdown = remaining; if (activeCooldownTimer) clearInterval(activeCooldownTimer); activeCooldownTimer = setInterval(() => { countdown--; if (formContainer.classList.contains('cooldown-active')) { if (countdown > 0) { errorMsg.textContent = `密码错误！请等待 ${countdown} 秒...`; } else { errorMsg.textContent = `请稍候...`; clearInterval(activeCooldownTimer); activeCooldownTimer = null; } } else { clearInterval(activeCooldownTimer); activeCooldownTimer = null; } }, 1000); if (activeCooldownTimeout) clearTimeout(activeCooldownTimeout); activeCooldownTimeout = setTimeout(() => { activeCooldownTimer = null; if (formContainer.classList.contains('cooldown-active')) { console.log(`前端冷却结束。重新启用控件。`); clearCooldownState(false); errorMsg.textContent = ''; } else { console.log(`服务器冷却时间到，但 UI 状态已改变。`); clearCooldownState(true); } activeCooldownTimeout = null; }, remaining * 1000); }

        // --- 密码验证函数 (保持不变) ---
        async function checkPasswords() {
            const pass1 = passwordInput1.value;
            if (!pass1) { errorMsg.textContent = '请输入密钥。'; return; }
            submitButton.disabled = true; passwordInput1.disabled = true;
            submitButton.textContent = '验证中...'; errorMsg.textContent = '';
            formContainer.classList.remove('cooldown-active');
            if (activeCooldownTimer) clearInterval(activeCooldownTimer); activeCooldownTimer = null;
            if (activeCooldownTimeout) clearTimeout(activeCooldownTimeout); activeCooldownTimeout = null;
            try {
                const response = await fetch('https://abyssal3.asterveil.top/api/check-next-passwords', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password_1: pass1, password_2: '' }),
                });
                let data = {};
                try { data = await response.json(); }
                catch (e) { data = { message: `服务器响应无效 (状态: ${response.status})` }; }

                if (response.ok && data.correct) {
                    console.log("下一阶段密码正确！正在跳转...");
                    clearCooldownState(true);
                    window.location.href = './img/f.png'; // 跳转到图片
                } else {
                    passwordInput1.value = '';
                    if (data.cooldown && data.remaining > 0) {
                         errorMsg.textContent = data.message || `密码错误！请等待 ${data.remaining} 秒...`;
                         startFrontendCooldownTimers(data.remaining);
                    } else {
                        errorMsg.textContent = data.message || '密码错误！';
                        clearCooldownState(false);
                    }
                }
            } catch (error) {
                console.error("检查下一阶段密码时出错:", error);
                errorMsg.textContent = '验证时发生网络错误，请稍后重试。';
                clearCooldownState(false);
            }
        }

        // --- 节点弹出/关闭逻辑 (保持不变) ---
        function closeAllDetails() { /* ... */ }
        nodeCircles.forEach(circle => { /* ... */ });
        nodesContainer.addEventListener('click', (event) => { /* ... */ });
        // (省略了节点逻辑的完整代码)
         function closeAllDetails() { nodeDetailsPanels.forEach(panel => panel.classList.remove('visible')); }
        nodeCircles.forEach(circle => { circle.addEventListener('click', (event) => { event.stopPropagation(); const parentNode = circle.closest('.node'); const detailsPanel = parentNode.querySelector('.node-details'); if (detailsPanel) { const isVisible = detailsPanel.classList.contains('visible'); closeAllDetails(); if (!isVisible) { detailsPanel.classList.add('visible'); } } }); });
        nodesContainer.addEventListener('click', (event) => { if (event.target.classList.contains('close-details-btn')) { event.stopPropagation(); const detailsPanel = event.target.closest('.node-details'); if (detailsPanel) { detailsPanel.classList.remove('visible'); } } });


        // --- 全局点击事件监听器 (包括音乐播放和关闭节点) ---
        document.addEventListener('click', (event) => {
            // 1. 音乐播放逻辑 (只在第一次点击时触发)
            if (!musicPlayed && backgroundMusic) {
                backgroundMusic.play().then(() => {
                    console.log("背景音乐已开始播放。");
                    musicPlayed = true; // 标记为已播放
                }).catch(error => {
                    // 播放可能会因为浏览器策略失败，尤其是在没有用户明确交互的情况下
                    console.error("背景音乐播放失败:", error);
                    // 这里可以不设置 musicPlayed = true，允许下次点击再尝试
                });
            }

            // 2. 关闭节点面板逻辑 (保持不变)
            const clickedInsideDetails = event.target.closest('.node-details');
            const clickedOnCircle = event.target.closest('.node-circle');
            if (!clickedInsideDetails && !clickedOnCircle) {
                closeAllDetails();
            }
        });


        // --- 其他事件监听器 (保持不变) ---
        submitButton.addEventListener('click', checkPasswords);
        passwordInput1.addEventListener('keypress', (event) => {
             if (event.key === 'Enter' && !submitButton.disabled) {
                event.preventDefault(); checkPasswords();
            }
        });

        // 页面加载时清理初始状态 (保持不变)
        clearCooldownState(true);

    </script>
</body>
</html>